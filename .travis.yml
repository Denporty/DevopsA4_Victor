language: php
php:
- '7.4'
- '8.0'
services:
- mysql
cache:
  directories:
  - node_modules
  - vendor
before_script:
- cp .env.travis .env
- sudo mysql -e 'create database testing;'
- composer self-update
- composer install --prefer-source --no-interaction --dev
- php artisan migrate
script:
- npm install
branches:
  only:
  - main
  - develop
  - preprod
deploy:
  provider: heroku
  api_key: "$HEROKU_KEY"
  app:
    master: "$HEROKU_APP_PROD"
    pre-prod: "$HEROKU_APP_PREPROD"
    dev: "$HEROKU_APP_DEV"
after_success:
  - wget https://raw.githubusercontent.com/DiscordHooks/travis-ci-discord-webhook/master/send.sh
  - chmod +x send.sh
  - ./send.sh success $WEBHOOK_URL
after_failure:
  - wget https://raw.githubusercontent.com/DiscordHooks/travis-ci-discord-webhook/master/send.sh
  - chmod +x send.sh
  - ./send.sh failure $WEBHOOK_URL
redis:
  image: redis
  restart: always
  ports:
  - 16379:6379
