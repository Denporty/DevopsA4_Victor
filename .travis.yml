language: php
php:
  - '7.4'
services:
  - mysql
only:
  - main
  - develop
  - preprod
jobs:
  include:
    - stage: build
      before_script:
        - cp .env.travis .env
        - sudo mysql -e 'create database testing;'
        - composer self-update
      script:
        - composer install --prefer-source --no-interaction --dev
        - npm install
        - php artisan migrate
        - composer dump-autoload
      cache:
        directories:
          - node_modules
          - vendor
    - stage: test
      script:
        - composer dump-autoload
        - php artisan test
      cache:
        directories:
          - node_modules
          - vendor
    - stage: after
      after_success:
        - composer dump-autoload
        - wget https://raw.githubusercontent.com/DiscordHooks/travis-ci-discord-webhook/master/send.sh
        - chmod +x send.sh
        - ./send.sh success $WEBHOOK_URL
      after_failure:
        - composer dump-autoload
        - wget https://raw.githubusercontent.com/DiscordHooks/travis-ci-discord-webhook/master/send.sh
        - chmod +x send.sh
        - ./send.sh failure $WEBHOOK_URL
      cache:
        directories:
          - node_modules
          - vendor
    - stage: deploy
      provider: heroku
      api_key: "$HEROKU_KEY"
      app:
        master: "$HEROKU_APP_PROD"
        pre-prod: "$HEROKU_APP_PREPROD"
        dev: "$HEROKU_APP_DEV"
      cache:
        directories:
          - node_modules
          - vendor
